å¤ªå¥½äº† ğŸ‘
è¿™æ˜¯**æœ€æ­£ç¡®ã€æœ€ä¸“ä¸š**çš„å†³å®šï¼Œè€Œä¸”ä½ ç°åœ¨å·²ç»æœ‰**å……åˆ†è¯æ®**ï¼Œåç«¯åŸºæœ¬ä¸ä¼šåå¯¹ã€‚

ä¸‹é¢æˆ‘ç»™ä½ ä¸€ä»½**ã€Œå¯ç›´æ¥äº¤ç»™åç«¯/è¿ç»´æ‰§è¡Œçš„å®Œæ•´ checklistã€**ï¼Œ
åŒ…å« **ä¸ºä»€ä¹ˆè¦å¼€ã€æ€ä¹ˆå¼€ã€æ€ä¹ˆéªŒè¯ã€æ€ä¹ˆå›æ»š**ï¼Œå…¨æ˜¯å·¥ç¨‹çº§å†…å®¹ã€‚

---

# âœ… å¼€å¯ Jitsi XMPP WebSocketï¼ˆ`/xmpp-websocket`ï¼‰å®Œæ•´ Checklist

> **ç›®æ ‡**
>
> * å¯ç”¨æ ‡å‡† XMPP over WebSocket
> * ä¸å½±å“ç°æœ‰æµè§ˆå™¨ç”¨æˆ·
> * ä¸ºåè®®çº§å‹æµ‹ / è‡ªåŠ¨åŒ–å®¢æˆ·ç«¯æ‰“å¼€å…¥å£

---

## ä¸€ã€ä¸ºä»€ä¹ˆå¿…é¡»å¼€ï¼ˆç»™åç«¯çœ‹çš„ç†ç”±ï¼‰

### 1ï¸âƒ£ è¿™æ˜¯ Jitsi å®˜æ–¹æ¨èçš„ç°ä»£æ¥å…¥æ–¹å¼

* lib-jitsi-meet **ä¼˜å…ˆä½¿ç”¨ WebSocket**
* BOSH å·²è¢«è®¤ä¸ºæ˜¯ **legacy**
* å®˜æ–¹æ–‡æ¡£ & ç¤¾åŒºéƒ½åœ¨æ¨è¿› WebSocket

ğŸ‘‰ **ä¸æ˜¯â€œç‰¹æ®Šéœ€æ±‚â€ï¼Œè€Œæ˜¯æ ‡å‡†èƒ½åŠ›**

---

### 2ï¸âƒ£ ä¸å¼€ WebSocketï¼Œæ— æ³•åšåè®®çº§å‹æµ‹

å½“å‰çŠ¶æ€ï¼ˆä½ å·²éªŒè¯ï¼‰ï¼š

| æ¥å…¥æ–¹å¼                          | çŠ¶æ€ |
| ----------------------------- | -- |
| æµè§ˆå™¨                           | âœ…  |
| BOSH (`/http-bind`)           | âŒ  |
| WebSocket (`/xmpp-websocket`) | âŒ  |

ğŸ‘‰ å¯¼è‡´ï¼š

* åªèƒ½ Seleniumï¼ˆå•æœº 100~150ï¼‰
* æ— æ³•åšé«˜å¹¶å‘å®¹é‡è¯„ä¼°
* å‹æµ‹æˆæœ¬æé«˜

---

### 3ï¸âƒ£ å¼€ WebSocket **ä¸å½±å“ç°æœ‰ç”¨æˆ·**

* æµè§ˆå™¨ç»§ç»­èµ°åŸè·¯å¾„
* WebSocket åªæ˜¯**å¢åŠ ä¸€ä¸ªå…¥å£**
* ä¸ä¼šæ”¹ä¸šåŠ¡é€»è¾‘

---

## äºŒã€æ”¹åŠ¨èŒƒå›´ï¼ˆéå¸¸å°ï¼‰

> **åªæ¶‰åŠ Prosody + Nginx**
> **ä¸æ”¹ Jitsi Meet / JVB / Jicofo**

---

## ä¸‰ã€Prosody é…ç½®ï¼ˆæ ¸å¿ƒï¼‰

### 1ï¸âƒ£ å¯ç”¨ WebSocket æ¨¡å—

ç¼–è¾‘ï¼š

```bash
/etc/prosody/prosody.cfg.lua
```

ç¡®ä¿æœ‰ï¼š

```lua
modules_enabled = {
    -- existing modules ...
    "websocket";
    "smacks";   -- æ¨èï¼Œä¸€èˆ¬å·²ç»æœ‰
}
```

âš ï¸ å¦‚æœæ˜¯è™šæ‹Ÿä¸»æœºé…ç½®ï¼ˆ`VirtualHost`ï¼‰ï¼Œä¹Ÿéœ€è¦ç¡®è®¤æ²¡æœ‰ç¦ç”¨ã€‚

---

### 2ï¸âƒ£ ç¡®è®¤ WebSocket ç«¯å£ï¼ˆé»˜è®¤ï¼‰

Prosody é»˜è®¤åœ¨ **5280** æä¾›ï¼š

```text
/ws
/xmpp-websocket
```

ä¸€èˆ¬ä¸ç”¨æ”¹ã€‚

---

## å››ã€Nginx é…ç½®ï¼ˆæœ€å®¹æ˜“æ¼ï¼‰

### 1ï¸âƒ£ å¢åŠ  WebSocket åå‘ä»£ç†

åœ¨ Jitsi çš„ Nginx server block ä¸­åŠ å…¥ï¼š

```nginx
location /xmpp-websocket {
    proxy_pass http://127.0.0.1:5280/xmpp-websocket;
    proxy_http_version 1.1;

    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;

    proxy_read_timeout 3600;
    proxy_send_timeout 3600;
}
```

âš ï¸ æ³¨æ„ï¼š

* **å¿…é¡»æ˜¯ HTTP/1.1**
* å¿…é¡»è®¾ç½® `Upgrade` / `Connection`

---

### 2ï¸âƒ£ HTTPS åœºæ™¯æ— éœ€ç‰¹æ®Šå¤„ç†

* è¯ä¹¦ä¸å˜
* 443 ç«¯å£ç»§ç»­ä½¿ç”¨

---

## äº”ã€é‡å¯ & çƒ­åŠ è½½

```bash
systemctl restart prosody
nginx -t && systemctl reload nginx
```

---

## å…­ã€éªŒè¯ Checklistï¼ˆéå¸¸é‡è¦ï¼‰

### 1ï¸âƒ£ curl éªŒè¯ï¼ˆæœ€æƒå¨ï¼‰

```bash
curl -i \
  -H "Connection: Upgrade" \
  -H "Upgrade: websocket" \
  -H "Sec-WebSocket-Version: 13" \
  -H "Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==" \
  -H "Sec-WebSocket-Protocol: xmpp" \
  -H "Origin: https://meet.armonia.fund" \
  https://meet.armonia.fund/xmpp-websocket
```

âœ… æ­£ç¡®ç»“æœï¼š

```http
HTTP/1.1 101 Switching Protocols
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Protocol: xmpp
```

---

### 2ï¸âƒ£ æµè§ˆå™¨ä¸å—å½±å“éªŒè¯

* æ‰“å¼€ `https://meet.armonia.fund/test1`
* èƒ½æ­£å¸¸è¿›ä¼šå³å¯

---

### 3ï¸âƒ£ Python éªŒè¯ï¼ˆä½ å·²ç»æœ‰ï¼‰

```python
websockets.connect(
    "wss://meet.armonia.fund/xmpp-websocket",
    subprotocols=["xmpp"],
    additional_headers={"Origin": "https://meet.armonia.fund"},
)
```

---

## ä¸ƒã€å®‰å…¨å»ºè®®ï¼ˆåç«¯å¸¸é—®ï¼‰

### æ˜¯å¦ä¼šè¢«æ»¥ç”¨ï¼Ÿ

* å»ºè®®é…åˆï¼š

  * JWT
  * rate limit
* ä¸å»ºè®®å¼€æ”¾åŒ¿åç”Ÿäº§ç¯å¢ƒ

### æ˜¯å¦å¿…é¡»å¼€æ”¾å…¬ç½‘ï¼Ÿ

* å¯é™åˆ¶ IP
* å¯åªå¯¹å†…ç½‘ / å‹æµ‹æœºå¼€æ”¾

---

## å…«ã€å›æ»šæ–¹æ¡ˆï¼ˆ1 åˆ†é’Ÿï¼‰

```nginx
# æ³¨é‡Šæ‰ xmpp-websocket location
systemctl reload nginx
```

Prosody æ— éœ€å›æ»šã€‚

---

## ä¹ã€å¼€å¯åçš„æ”¶ç›Šï¼ˆç»™é¢†å¯¼çœ‹çš„ï¼‰

| é¡¹      | å‰    | å            |
| ------ | ---- | ------------ |
| å•æœºå‹æµ‹èƒ½åŠ› | ~150 | **800~1500** |
| å‹æµ‹æˆæœ¬   | é«˜    | ä½            |
| æ˜¯å¦å¯è‡ªåŠ¨åŒ– | âŒ    | âœ…            |
| æ˜¯å¦å¯ CI | âŒ    | âœ…            |

---

# ğŸš€ ä½ ä¸‹ä¸€æ­¥è¦åšä»€ä¹ˆï¼ˆéå¸¸æ¸…æ™°ï¼‰

1ï¸âƒ£ æŠŠè¿™ä»½ checklist å‘ç»™åç«¯
2ï¸âƒ£ ç­‰ä»–ä»¬è¯´â€œå·²å¼€â€
3ï¸âƒ£ ä½ è·‘ä¸€æ¡ curlï¼Œçœ‹ 101
4ï¸âƒ£ æˆ‘å¸®ä½  **æŠŠ Python å‹æµ‹å™¨æ‹‰åˆ° 500+**

---

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘è¿˜å¯ä»¥å¸®ä½ ï¼š

* âœï¸ **å†™ä¸€æ®µâ€œå‘ç»™åç«¯çš„ç®€çŸ­è¯´æ˜ç‰ˆæœ¬â€**
* ğŸ§ª **å¼€å®Œåï¼Œç»™ä½ æœ€ç»ˆç‰ˆå¹¶å‘å‹æµ‹è„šæœ¬**
* ğŸ“Š **æ•™ä½ æ€ä¹ˆæŠŠå‹æµ‹ç»“æœå˜æˆå¯æ±‡æŠ¥çš„æ•°æ®**

ä½ å·²ç»èµ°åˆ°äº†**å·¥ç¨‹å†³ç­– + è½åœ°æ‰§è¡Œ**è¿™ä¸€æ­¥ï¼Œ
æ¥ä¸‹æ¥åªå‰©â€œå®æ–½â€äº†ã€‚
